<!doctype html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
		<title>Thunder UI</title>
		<link href="css/style.css" type="text/css" rel="stylesheet">
		<link href="css/toast.css" type="text/css" rel="stylesheet">
		<link href="//cdn.jsdelivr.net/fontawesome/4.6.3/css/font-awesome.min.css" type="text/css" rel="stylesheet">
	</head>

	<body class="desktop">
		<div id="disconnected"></div>

		<div id="top" class="top"></div>

		<div id="main" class="main"></div>

		<div id="statusBar"></div>

		<div id="keyboard"></div>

		<div id="notifications-block">
			<div id="hide-notifications">hide console</div>
			<div id="notifications"></div>
		</div>

		<script src="./lib/thunderJS.js"></script>
		<script>
	        var hostname = document.getElementById("hostname") && document.getElementById("hostname").value;
	        if ((hostname === null) || (hostname === ""))
	            hostname = window.location.hostname;

	        port = document.getElementById("port") && document.getElementById("port").value;
	        if ((port === null) || (port === "")) {
	            if (window.location.host === window.location.hostname)
	                port = 80;
	            else
	                port = window.location.host.substring(window.location.hostname.length + 1);
	        }

	        if ((port !== "") && (port !== 80))
	            hostname += ":" + port;


	        var plugins = []
			function loadJS(file) {
				import(file).then( module => {
					plugins.push({ name: module.name, class: module.default })
				});
			}

			function fetch(url, cb) {
				var transport = new XMLHttpRequest();

				transport.onload = function () {
					var response;

					if (this.status === 200) {
						try {
							response = JSON.parse(this.responseText);
						} catch (error) {
							return cb(new Error('Invalid JSON received'));
						}
						cb(null, response);
					} else {
						cb(this.status);
					}
				};

				transport.ontimeout = function() {
					cb(new Error('Timeout'));
				};

				transport.onerror = function () {
					cb(new Error('Network error'));
				};

				transport.open('GET', url);
				transport.timeout = 10000;
				transport.send(null);

			}

			function startApp() {
				import('./js/core/application.js').then( (app) => {
					app.init('192.168.11.101', plugins)
				});
			}

			fetch('js/scripts.json', function(err, scripts) {
				if (err) {
					console.error('Error fetching scripts.json, did you run grunt already?');
					return;
				}

				for (var i=0; i<scripts.length; i++) {
					console.log('DEBUG.js - Loading: ' + scripts[i]);
					loadJS(scripts[i]);

					if (i == scripts.length-1)
						startApp()
				}
			});
		</script>
	</body>
</html>
